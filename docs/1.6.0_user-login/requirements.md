# v1.6.0 登录体系升级 需求文档

> 版本：1.6.0 | 日期：2026-02-07 | 状态：需求评审

---

## 背景

当前项目仅支持 GitHub OAuth 登录，存在两个问题：

1. **门槛高**：非开发者没有 GitHub 账号，无法登录
2. **登录后无功能**：登录后除了「+ Skill」跳转 GitHub Issue，没有任何用户相关功能

v1.6 聚焦解决第一个问题：**在保留 GitHub 登录的基础上，新增 Email + Password 登录方式**，为后续的收藏、投稿、评论等功能打好认证基础。

---

## 现状

| 项目 | 现状 |
|------|------|
| GitHub OAuth 登录 | ✅ 已实现（PKCE） |
| Email + Password | ❌ 未启用 |
| 登录 UI | ⚠️ 直接跳转 GitHub，无弹窗 |
| 用户 Profile 表 | ❌ 仅依赖 Supabase 内置 `auth.users` 表 |
| 密码重置 | ❌ 无 |
| 用户菜单 | ⚠️ 仅有"退出"按钮 |

---

## 需求清单

### 一、启用 Email + Password 登录

在 Supabase Dashboard 中启用 Email Provider，支持邮箱注册和登录。

- 最少 8 位密码
- 开发阶段先关闭邮箱验证，上线前再开启
- 无额外费用（Free 套餐包含 50,000 MAU）

---

### 二、登录弹窗

#### 触发方式

点击 Header「登录」按钮，弹出登录弹窗（替代当前的直接跳转 GitHub）。

#### 弹窗布局

```
┌──────────── 登录 Skill Hub ────────────┐
│                                    [✕] │
│                                         │
│  ┌───────────────────────────────────┐  │
│  │ 邮箱地址                          │  │
│  ├───────────────────────────────────┤  │
│  │ 密码                              │  │
│  └───────────────────────────────────┘  │
│                                         │
│  [        登  录        ]               │
│                                         │
│  没有账号？注册    ·    忘记密码？      │
│                                         │
│  ──────────── 或 ────────────          │
│                                         │
│  [  🐙  使用 GitHub 登录  ]            │
│                                         │
└─────────────────────────────────────────┘
```

#### 三种视图（同一弹窗内切换）

| 视图 | 内容 | 切换方式 |
|------|------|----------|
| **登录**（默认） | 邮箱 + 密码 + 登录按钮 + GitHub 按钮 | — |
| **注册** | 邮箱 + 密码 + 确认密码 + 注册按钮 | 点击"注册"链接 |
| **忘记密码** | 邮箱 + 发送重置链接按钮 | 点击"忘记密码？"链接 |

#### 表单校验

| 字段 | 规则 |
|------|------|
| 邮箱 | 必填，合法邮箱格式 |
| 密码 | 必填，最少 8 位 |
| 确认密码（注册） | 必填，与密码一致 |

#### 交互细节

| 场景 | 行为 |
|------|------|
| 登录成功 | 关闭弹窗，Header 更新为已登录态（头像 + 用户菜单） |
| 注册成功 | 自动登录并关闭弹窗，Toast 提示"注册成功" |
| 邮箱已注册 | 表单下方红字提示"该邮箱已注册，请直接登录" |
| 密码错误 | 表单下方红字提示"邮箱或密码错误" |
| 忘记密码提交 | Toast 提示"重置链接已发送到邮箱"，切回登录视图 |
| GitHub 登录 | 走现有 OAuth 流程（不变） |
| 按 ESC / 点击遮罩 | 关闭弹窗 |
| Loading 态 | 提交后按钮显示 Loading 动画，禁止重复点击 |

#### 移动端适配

- 弹窗改为从底部滑出的 **Bottom Sheet**（与现有 ActionSheet 风格一致）
- 表单输入框适配移动端键盘
- GitHub 按钮同样保留

---

### 三、密码重置页

**流程**：
1. 用户在弹窗点「忘记密码」→ 输入邮箱 → 发送重置邮件
2. 用户点击邮件中的链接 → 进入重置密码页
3. 页面展示「设置新密码」表单（新密码 + 确认密码）
4. 提交成功 → Toast "密码已重置" → 自动跳转首页

**UI**：居中卡片式布局，与登录弹窗视觉风格一致

---

### 四、用户 Profile 表

即使本期只做登录，也建议同步建好用户 Profile 表，因为：
- Email 用户没有 GitHub 头像和用户名，需要有地方存昵称
- 建表成本极低，避免后续补建的迁移麻烦

**需要存储的字段**：

| 字段 | 说明 |
|------|------|
| 昵称 | GitHub 用户取 username，邮箱用户取邮箱前缀 |
| 头像 | GitHub 用户取 GitHub 头像，邮箱用户留空 |
| 个人简介 | 可选，本期不做编辑入口 |

**自动化**：
- 用户注册时（无论 GitHub 还是 Email）自动创建 Profile 记录
- 已有 GitHub 用户需要一次性数据迁移补建记录

---

### 五、用户菜单优化

**现状**：登录后仅显示 GitHub 头像 + "退出"按钮

**改动**：
- 邮箱用户没有头像 → 显示**昵称首字符**作为默认头像（圆形色块 + 文字）
- 菜单中显示昵称

```
┌─────── 用户菜单 ───────┐
│  头像  昵称             │
│  ──────────────        │
│  🚪  退出登录           │
└─────────────────────────┘
```

**注意**：「我的收藏」「我的投稿」等菜单项留到后续版本，本期仅优化头像和昵称显示。

---

## 验收标准

### 登录弹窗
- [ ] 点击「登录」弹出弹窗（非直接跳转 GitHub）
- [ ] 弹窗包含邮箱登录表单 + GitHub 登录按钮
- [ ] 可在登录/注册/忘记密码三个视图间切换
- [ ] 按 ESC 或点击遮罩可关闭弹窗
- [ ] 移动端弹窗为 Bottom Sheet 样式

### Email 登录
- [ ] 邮箱 + 密码注册成功后自动登录，弹窗关闭
- [ ] 邮箱 + 密码登录成功后弹窗关闭，Header 更新
- [ ] 邮箱已注册时提示"该邮箱已注册"
- [ ] 密码错误时提示"邮箱或密码错误"
- [ ] 表单校验：邮箱格式、密码 ≥ 8 位、确认密码一致

### GitHub 登录
- [ ] 弹窗中 GitHub 按钮仍走现有 OAuth 流程，行为不变
- [ ] 已有 GitHub 用户登录后正常显示头像和菜单

### 密码重置
- [ ] 忘记密码 → 输入邮箱 → Toast 提示"重置链接已发送"
- [ ] 点击邮件链接 → 进入重置密码页 → 设置新密码 → 成功跳转首页

### 用户 Profile
- [ ] 新注册用户（GitHub / Email）自动创建 Profile 记录
- [ ] GitHub 用户：昵称=GitHub 用户名，头像=GitHub 头像
- [ ] Email 用户：昵称=邮箱前缀，头像=首字符默认头像
- [ ] 用户菜单显示昵称

---

## 不在本期范围

| 功能 | 预计版本 |
|------|----------|
| 收藏/书签 | v1.7 |
| 站内投稿（替代 GitHub Issue） | v1.7 |
| 个人中心 / 主页 | v1.7 |
| 评论系统 | v1.8 |
| 积分 + 排行榜 | v1.8 |
